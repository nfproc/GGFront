<!-- GGFront: A GHDL/GTKWave GUI Frontend
     Copyright (C) 2018-2025 Naoki FUJIEDA. New BSD License is applied.
     *******************************************************************-->

<Window x:Class="GGFront.Views.MainWindow"
        xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:GGFront.ViewModels"
        xmlns:local="clr-namespace:GGFront.ViewModels.MainConverter"
        x:DataType="vm:MainViewModel"
        Icon="/Assets/GGFront.ico"
        mc:Ignorable="d"
        Title="GGFront" Height="600" Width="640" MinHeight="400" MinWidth="480" Closed="Window_Closed">
    <Design.DataContext>
        <vm:MainViewModel/>
    </Design.DataContext>

    <Window.Resources>
        <local:HierarchyLevelConverter x:Key="LevelConverter"/>
        <local:HierarchyPathConverter x:Key="PathConverter"/>
        <local:HierarchyTopColorConverter x:Key="TopColorConverter"/>
        <local:HierarchyTopFontConverter x:Key="TopFontConverter"/>
        <local:TimeLimitConverter x:Key="TimeLimitConverter"/>
        <local:VHDLVersionConverter x:Key="VHDLVersionConverter"/>
        <local:WavePathConverter x:Key="WavePathConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition MinHeight="100"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition MinHeight="100"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Margin="0,10,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" MinWidth="90"/>
                <ColumnDefinition Width="Auto" MinWidth="120"/>
                <ColumnDefinition Width="Auto" MinWidth="90"/>
                <ColumnDefinition />
                <ColumnDefinition Width="Auto" MinWidth="120"/>
            </Grid.ColumnDefinitions>

            <Label HorizontalAlignment="Left" VerticalAlignment="Center"
                   Margin="10,0,0,0" Content="Sim Limit" Height="32" Width="80"/>
            <ComboBox x:Name="cmbSimLimit" Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Top"
                      Margin="5,0,0,0"
                      ItemsSource="{Binding SimLimits, Converter={StaticResource TimeLimitConverter}}"
                      SelectedValue="{Binding SimLimit, Converter={StaticResource TimeLimitConverter}}"
                      SelectionChanged="Simlimit_SelectionChanged"/>
            <Label Grid.Column="2" HorizontalAlignment="Left" VerticalAlignment="Center"
                   Margin="5,0,0,0" Content="Real Limit" Height="32" Width="80"/>
            <ComboBox x:Name="cmbProcLimit" Grid.Column="3" HorizontalAlignment="Left" VerticalAlignment="Top"
                      Margin="5,0,0,0"
                      ItemsSource="{Binding ProcLimits, Converter={StaticResource TimeLimitConverter}}"
                      SelectedValue="{Binding ProcLimit, Converter={StaticResource TimeLimitConverter}}"
                      SelectionChanged="Proclimit_SelectionChanged"/>
            <Button x:Name="btnShowSettings" Grid.Column="4" HorizontalAlignment="Center" VerticalAlignment="Bottom"
                    HorizontalContentAlignment="Center" Margin="10,0,10,5" BorderBrush="DarkGray"
                    Content="Settings" Width="90" Click="ShowSettings_Click"/>
        </Grid>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" MinWidth="120"/>
                <ColumnDefinition />
            </Grid.ColumnDefinitions>

            <Label HorizontalAlignment="Left" VerticalAlignment="Center"
                   Margin="10,5,0,0" Content="Source File(s)" Height="32" Width="110"/>
            <TextBlock Name="lblVHDLStd" Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center"
                       FontSize="10" Text="{Binding VHDLVersion, Converter={StaticResource VHDLVersionConverter}}" />
        </Grid>

        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition/>
                <ColumnDefinition Width="Auto" MinWidth="120"/>
            </Grid.ColumnDefinitions>

            <!-- NOTE: DragDrop.Drop="Sources_Drop" に相当するイベント登録は C# 側で行っている -->
            <ListBox x:Name="lstSources" Grid.RowSpan="2" Margin="10,0,0,0" DragDrop.AllowDrop="True"
                     ItemsSource="{Binding SourceCollection}" SelectionMode="Multiple,Toggle"
                     Background="White" BorderBrush="DarkGray" BorderThickness="1"
                     ScrollViewer.HorizontalScrollBarVisibility="Auto" KeyDown="Sources_KeyDown">
                <ListBox.Styles> 
                    <Style Selector="ListBoxItem">
                        <Setter Property="Padding" Value="4,2" />
                    </Style> 
                </ListBox.Styles>
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding Name}"/>
                    </DataTemplate>
                </ListBox.ItemTemplate>
                <ListBox.ItemContainerTheme>
                    <ControlTheme TargetType="ListBoxItem" BasedOn="{StaticResource {x:Type ListBoxItem}}"
                                  x:DataType="vm:SourceItem">
                        <Setter Property="IsSelected" Value="{Binding Selected}"/>
                    </ControlTheme>
                </ListBox.ItemContainerTheme>
            </ListBox>
            <Button x:Name="btnAddSource" Grid.Column="1" HorizontalAlignment="Center"
                    VerticalAlignment="Bottom" HorizontalContentAlignment="Center" Margin="10,0,10,5"
                    BorderBrush="DarkGray" Content="Add" Width="90" Click="AddSource_Click"/>
            <Button x:Name="btnRemoveSource" Grid.Row="1" Grid.Column="1" HorizontalAlignment="Center"
                    VerticalAlignment="Top" HorizontalContentAlignment="Center" Margin="10,5,10,0"
                    BorderBrush="DarkGray" Content="Remove" Width="90" Click="RemoveSource_Click"/>
        </Grid>

        <Grid Grid.Row="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" MinWidth="120"/>
                <ColumnDefinition/>
            </Grid.ColumnDefinitions>

            <Label HorizontalAlignment="Left" VerticalAlignment="Center" Margin="10,5,0,0"
                   Content="Hierarchy" Height="32" Width="110"/>
            <TextBlock Name="lblTopModule" Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Center"
                       FontSize="10" Text="{Binding WavePath, Converter={StaticResource WavePathConverter}}" />
        </Grid>

        <Grid Grid.Row="4">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition/>
                <ColumnDefinition Width="Auto" MinWidth="120"/>
            </Grid.ColumnDefinitions>
            
        <ListBox x:Name="lstHierarchy" ItemsSource="{Binding HierarchyCollection}" Grid.RowSpan="2"
                 Background="White" BorderBrush="DarkGray" BorderThickness="1"
                 ScrollViewer.HorizontalScrollBarVisibility="Auto" Margin="10,0,0,0">
            <ListBox.Styles> 
                <Style Selector="ListBoxItem">
                    <Setter Property="Padding" Value="4,2" />                
                </Style>
            </ListBox.Styles>
            <ListBox.ItemTemplate>
                <!-- NOTE: TextBlock + Run だと時々再描画に失敗する．おそらく Avalonia のバグ? -->
                <DataTemplate>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Margin="{Binding Level, Converter={StaticResource LevelConverter}}"
                                   Text="{Binding Name}"
                                   FontWeight="{Binding IsTop, Converter={StaticResource TopFontConverter}}">
                            <TextBlock.Foreground>
                                <MultiBinding Converter="{StaticResource TopColorConverter}">
                                    <Binding Path="IsValid"/>
                                    <Binding Path="IsTop"/>
                                </MultiBinding>
                            </TextBlock.Foreground>
                        </TextBlock>
                        <TextBlock Text="{Binding ShortPath, Mode=OneWay, Converter={StaticResource PathConverter}}"
                                   FontSize="12" Foreground="Gray"/>
                    </StackPanel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
        <Button x:Name="btnSetAsTop" Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Top"
                HorizontalContentAlignment="Center" Margin="10,0,10,5" BorderBrush="DarkGray"
                Content="Set as Top" Width="90" Click="SetAsTop_Click"/>
        <Button x:Name="btnRefreshHiearchy" Grid.Row="1" Grid.Column="1" HorizontalAlignment="Left"
                HorizontalContentAlignment="Center" VerticalAlignment="Top" Margin="10,5" BorderBrush="DarkGray"
                Content="Refresh" Width="90" Click="Refresh_Click"/>
        </Grid>

        <Grid Grid.Row="5" Margin="0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition/>
            </Grid.ColumnDefinitions>
            <Button x:Name="btnCompile" Grid.Column="1" HorizontalAlignment="Left" VerticalAlignment="Top"
                    HorizontalContentAlignment="Center" Margin="5,0" BorderBrush="DarkGray"
                    Content="Compile &amp; Simulate" Width="150" Click="Compile_Click"/>
            <Button x:Name="btnViewWave" Grid.Column="2" HorizontalAlignment="Left" VerticalAlignment="Top"
                    HorizontalContentAlignment="Center" Margin="5,0" BorderBrush="DarkGray"
                    Content="View Waveform" Width="150" Click="ViewWave_Click"/>
            <Button x:Name="btnReset" Grid.Column="3" HorizontalAlignment="Left" VerticalAlignment="Top"
                    HorizontalContentAlignment="Center" Margin="5,0" BorderBrush="DarkGray"
                    Content="Reset Project" Width="120" Click="Reset_Click"/>
        </Grid>
    </Grid>
</Window>
